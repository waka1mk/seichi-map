const timeline = document.getElementById("timeline");

// ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆãªã‘ã‚Œã°åŒ¿åï¼‰
const currentUser = localStorage.getItem("username") || "åŒ¿å";

async function loadTimeline() {
  const { data, error } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error("å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    return;
  }

  timeline.innerHTML = "";

  data.forEach(post => {
    const card = document.createElement("div");
    card.className = "post-card";

    card.innerHTML = `
      <div class="post-header">
        <span class="post-user">ğŸ‘¤ ${post.username}</span>
        <button class="like-button" data-id="${post.id}">
          â¤ï¸ <span>${post.likes || 0}</span>
        </button>
      </div>

      <div class="post-location">
        ğŸ“ ${post.place || "å ´æ‰€æœªè¨­å®š"}
      </div>

      <div class="post-content">
        ${post.content}
      </div>

      <div class="post-date">
        ${new Date(post.created_at).toLocaleString()}
      </div>
    `;

    timeline.appendChild(card);
  });

  setupLikeButtons();
}

function setupLikeButtons() {
  document.querySelectorAll(".like-button").forEach(btn => {
    btn.onclick = async () => {
      const postId = btn.dataset.id;
      const countSpan = btn.querySelector("span");
      const newCount = Number(countSpan.textContent) + 1;

      countSpan.textContent = newCount;
      btn.classList.add("liked");
      setTimeout(() => btn.classList.remove("liked"), 200);

      await supabase
        .from("posts")
        .update({ likes: newCount })
        .eq("id", postId);
    };
  });
}

loadTimeline();
